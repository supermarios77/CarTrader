datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

model User {
  id               BigInt     @id @default(autoincrement())
  email            String?    @unique
  phoneE164        String?    @unique
  passwordHash     String?
  salt             String?
  status           UserStatus @default(ACTIVE)
  displayName      String?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  lastLoginAt      DateTime?
  oauthAccounts    OAuthAccount[]
  otpChallenges    OtpChallenge[]
  auditLogs        UserAuditLog[]
  listings         Listing[]
  mediaAssets      MediaAsset[]
}

model Listing {
  id              BigInt          @id @default(autoincrement())
  seller          User            @relation(fields: [sellerId], references: [id], onDelete: Restrict)
  sellerId        BigInt
  title           String
  description     String
  priceCents      BigInt
  currencyCode    String          @default("PKR")
  status          ListingStatus   @default(DRAFT)
  type            ListingType
  year            Int?
  make            String?
  model           String?
  variant         String?
  mileageKm       Int?
  engineCapacity  Int?
  fuelType        FuelType?
  transmission    TransmissionType?
  bodyType        BodyType?
  exteriorColor   String?
  interiorColor   String?
  vin             String?
  registrationCity String?
  ownership       String?
  features        Json?
  locationCity    String?
  locationState   String?
  locationLatitude  Decimal?      @db.Decimal(12, 8)
  locationLongitude Decimal?      @db.Decimal(12, 8)
  publishedAt     DateTime?
  expiresAt       DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  media           ListingMedia[]

  @@index([sellerId, status, createdAt])
  @@index([status, type, createdAt])
  @@index([locationCity, locationState])
}

model ListingMedia {
  id          BigInt     @id @default(autoincrement())
  listing     Listing    @relation(fields: [listingId], references: [id], onDelete: Cascade)
  listingId   BigInt
  type        MediaType  @default(IMAGE)
  url         String
  storageKey  String
  sortOrder   Int        @default(0)
  metadata    Json?
  createdAt   DateTime   @default(now())
  asset       MediaAsset? @relation(fields: [assetId], references: [id], onDelete: SetNull)
  assetId     BigInt?

  @@index([listingId, sortOrder])
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ListingStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  SOLD
}

enum ListingType {
  CAR
  BIKE
  TRUCK
  SUV
  VAN
  BUS
  OTHER
}

enum FuelType {
  PETROL
  DIESEL
  CNG
  HYBRID
  ELECTRIC
  LPG
  OTHER
}

enum TransmissionType {
  MANUAL
  AUTOMATIC
  SEMI_AUTOMATIC
  CVT
}

enum BodyType {
  SEDAN
  HATCHBACK
  SUV
  CROSSOVER
  COUPE
  CONVERTIBLE
  WAGON
  VAN
  PICKUP
  OTHER
}

enum MediaType {
  IMAGE
  VIDEO
  DOCUMENT
}

model MediaAsset {
  id             BigInt             @id @default(autoincrement())
  storageKey     String             @unique
  bucket         String
  contentType    String?
  byteSize       BigInt?
  checksumSha256 String?
  status         MediaAssetStatus   @default(PENDING)
  visibility     MediaAssetVisibility @default(PRIVATE)
  uploadedAt     DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  owner          User?              @relation(fields: [ownerId], references: [id], onDelete: SetNull)
  ownerId        BigInt?
  listingUsages  ListingMedia[]

  @@index([ownerId, status, createdAt])
}

enum MediaAssetStatus {
  PENDING
  READY
  FAILED
  DELETED
}

enum MediaAssetVisibility {
  PRIVATE
  PUBLIC
}

model OAuthAccount {
  id            BigInt   @id @default(autoincrement())
  provider      String
  providerId    String
  accessToken   String?
  refreshToken  String?
  expiresAt     DateTime?
  metadata      Json?
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        BigInt
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([provider, providerId])
}

model OtpChallenge {
  id             BigInt      @id @default(autoincrement())
  contact        String
  code           String
  purpose        OtpPurpose
  expiresAt      DateTime
  consumedAt     DateTime?
  user           User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId         BigInt?
  attempts       Int         @default(0)
  maxAttempts    Int         @default(5)
  createdAt      DateTime    @default(now())

  @@index([contact, purpose])
}

enum OtpPurpose {
  SIGN_IN
  SIGN_UP
  PASSWORD_RESET
  MFA
}

model UserAuditLog {
  id          BigInt   @id @default(autoincrement())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      BigInt
  action      String
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([userId, createdAt])
}

model NotificationTemplate {
  id          BigInt              @id @default(autoincrement())
  key         String              @unique
  channel     NotificationChannel
  subject     String?
  body        String
  description String?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  notifications Notification[]
}

model Notification {
  id            BigInt               @id @default(autoincrement())
  template      NotificationTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  templateId    BigInt?
  channel       NotificationChannel
  recipient     String
  subject       String?
  body          String?
  payload       Json?
  status        NotificationStatus   @default(PENDING)
  error         String?
  attemptCount  Int                  @default(0)
  maxAttempts   Int                  @default(3)
  scheduledFor  DateTime?            @default(now())
  sentAt        DateTime?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
}

enum NotificationStatus {
  PENDING
  QUEUED
  DELIVERED
  FAILED
}
